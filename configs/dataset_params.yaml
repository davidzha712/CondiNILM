# Dataset-specific hyperparameters for NILM training.
#
# Loading precedence (later overrides earlier):
#   expes.yaml (base) → models.yaml → datasets.yaml (house splits)
#     → THIS FILE: training/loss/postprocess (OVERRIDES expes.yaml)
#       → HPO override (LAST, filtered for non-UKDALE)
#         → trainer.py _derive_params_from_stats() (OVERRIDES all alphas at runtime)
#
# Each dataset section contains:
#   metadata    - Dataset description and sampling info
#   appliances  - Per-device thresholds, durations, device_type, houses
#   training    - LR, batch size, epochs, overlap, etc.
#   loss        - Loss function params (output_ratio, anti-collapse, etc.)
#   postprocess - Per-device power threshold and min_on_steps for prediction cleanup

# ============================================================
# UKDALE Dataset Configuration
# ============================================================
UKDALE:
  metadata:
    name: "UK-DALE"
    description: "UK Domestic Appliance-Level Electricity"
    sampling_frequency: "6s"
    num_houses: 5
    location: "UK"

  appliances:
    washing_machine:
      min_threshold: 20
      max_threshold: 2500
      min_on_duration: 180
      min_off_duration: 16
      min_activation_time: 12
      device_type: "long_cycle"
      houses: [1, 2, 3, 4, 5]
      loss_override:
        w_recall: 0.28       # V14fix: 0.20→0.28 (WM had F1=0.021, near-zero output; needs recall push)
        w_energy: 0.10       # V14fix: 0.22→0.10 (high energy loss rewards all-zero for 5.6% duty)
        alpha_on: 3.0        # V14fix: 2.2→3.0 (stronger ON asymmetry for rare events)
        w_on_power: 0.12     # V14fix: 0.14→0.12
        w_off_fp: 0.10       # V14fix: 0.14→0.10 (was over-suppressing all output)
        off_margin: 0.01     # V14fix: NEW (base 0.015=120W → 0.01=80W, more appropriate for WM)
        w_hard_zero: 0.06    # V14fix: NEW (enforce zeros in true OFF regions)

    dishwasher:
      min_threshold: 10
      max_threshold: 2500
      min_on_duration: 180
      min_off_duration: 180
      min_activation_time: 12
      device_type: "long_cycle"
      houses: [1, 2]
      # V16: REMOVED loss_override — V12 achieved F1=0.554 with NO override (LONG_CYCLE defaults).
      # V14/V15 overrides caused all-ON collapse (P→0.10, R→0.99). Root cause: overrides
      # break PCGrad gradient balance for long_cycle devices. Let base params handle DW.

    kettle:
      min_threshold: 2000
      max_threshold: 3100
      min_on_duration: 1
      min_off_duration: 0
      min_activation_time: 1
      device_type: "sparse_high_power"
      houses: [1, 2]
      loss_override:
        off_margin: 0.005    # V14fix: 0.02→0.005 (dead zone 160W→40W)
        w_off_fp: 0.25       # V14fix2: 0.18→0.25 (KT R=0.997, need stronger FP suppression)
        w_recall: 0.08       # V14fix2: 0.30→0.08 (0.30 caused R=0.999; KT over-predicts, DON'T push recall)
        w_energy: 0.05       # V14fix: 0.15→0.05 (energy matching rewards all-zero for sparse)
        w_hard_zero: 0.12    # V14fix2: 0.10→0.12 (enforce zeros during OFF)
        alpha_on: 2.0        # V14fix2: 3.5→2.0 (3.5 caused fear-of-missing-ON → always-ON prediction)
        alpha_off: 1.5       # V14fix2: NEW (strengthen OFF regression to combat CNN bypass aggregate leak)
        w_main: 0.40         # V14fix2: 0.35→0.40 (restore main regression importance)

    microwave:
      min_threshold: 200
      max_threshold: 3000
      min_on_duration: 1
      min_off_duration: 3
      min_activation_time: 1
      device_type: "sparse_high_power"
      houses: [1, 2]
      loss_override:
        w_off_fp: 0.40       # V14fix: 0.35→0.40 (MW P=0.054, needs even stronger FP suppression)
        off_margin: 0.008    # V16fix: 0.003→0.008 (64W dead zone; old 24W too small for 90-100W device)
        alpha_off: 2.0       # V14fix: 1.5→2.0 (stronger OFF regression)
        w_hard_zero: 0.20    # V14fix: 0.15→0.20 (aggressively suppress false activations)
        w_energy: 0.05       # V14fix: 0.08→0.05 (further reduce aggregate tracking incentive)
        w_main: 0.30         # V14fix: 0.35→0.30 (make room for penalties)
        w_recall: 0.05       # V14fix: (base 0.20)→0.05 (MW has R=0.456/P=0.054; recall push is the ENEMY)
        alpha_on: 2.0        # V14fix: (base 2.8)→2.0 (reduce ON asymmetry; MW over-detects)

    fridge:
      min_threshold: 50
      max_threshold: 300
      min_on_duration: 6
      min_off_duration: 1
      min_activation_time: 1
      device_type: "cycling_low_power"
      houses: [1, 2, 4]
      loss_override:
        off_margin: 0.003    # V14: 0.015→0.003 (dead zone 120W→24W; fridge is ~100W, old margin covered ENTIRE fridge range!)
        w_off_fp: 0.22       # V14: 0.09→0.22 (strong OFF FP penalty - fridge has clear ON/OFF cycling)
        w_hard_zero: 0.10    # V14: 0.03→0.10 (enforce zero during OFF periods)
        alpha_off: 2.0       # V14: 1.0→2.0 (penalize OFF regression errors 2x)
        w_energy: 0.10       # V14: 0.20→0.10 (reduce energy matching to curb aggregate tracking)
        w_main: 0.45         # V14: 0.50→0.45 (make room for penalty components)

  training:
    default_sampling_rate: "1min"
    default_window_size: 128
    overlap: 0.75
    batch_size: 2048             # V11: Fill 5090 32GB VRAM (~17GB peak, ~63 steps/epoch)
    epochs: 50                   # V10: Full-data training needs more epochs
    learning_rate: 3e-4          # V11: Moderate scaling for batch=2048 (PCGrad stability)
    weight_decay: 1e-4           # V10: Better regularization
    early_stopping_patience: 12
    limit_train_batches: 1.0     # V14: Full data training
    limit_val_batches: 1.0       # Keep full validation for accurate F1 measurement
    # Default multi-device house split (used when datasets.yaml has no entry)
    # Houses 1,2 have all 5 devices with clean data; 3,4,5 have MW quality issues
    default_multi_train: [1]
    default_multi_test: [2]

  loss:
    loss_type: "multi_nilm"
    output_ratio: 0.9            # V10: Wider supervision window with full data
    anti_collapse_weight: 0.3    # V10: Reduced — full data prevents collapse naturally
    state_zero_penalty_weight: 0.0
    state_zero_kernel: 0
    off_high_agg_penalty_weight: 0.0

  postprocess:
    washing_machine:
      threshold: 60              # V14fix: 80→60 (WM low-power wash phases 50-150W, don't clip them)
      min_on_steps: 10           # V14fix: 12→10 (slightly more permissive for sub-cycles)
      min_off_steps: 5           # Keep: fill short OFF gaps in multi-phase WM cycles
      max_power: 2500            # Clip to training max_threshold
    dishwasher:
      threshold: 30              # V14fix: 50→30 (DW low-power phases ~30-80W; 50 clips real signal)
      min_on_steps: 6            # V14fix: 8→6 (more permissive for short DW sub-cycles)
      min_off_steps: 3           # Keep: fill short OFF gaps
      max_power: 2500            # Clip to training max_threshold
    kettle:
      threshold: 350             # V14fix2: 200→350 (200 too low, lets CNN bypass aggregate noise through; KT peaks 500-1200W at 1min)
      min_on_steps: 2            # V14fix2: 1→2 (require 2 consecutive bins to filter noise)
      max_power: 3100            # Clip to training max_threshold
    microwave:
      threshold: 120             # V16fix: 70→120 (MW min=200W; 70W lets 40-60W noise through. KT=350/2000=17.5%, MW=120/200=60%)
      min_on_steps: 2            # V16fix: 1→2 (require 2 consecutive bins above threshold to filter single-point noise)
      max_power: 3000            # Clip to training max_threshold
    fridge:
      threshold: 18
      min_on_steps: 3
      max_power: 300             # Clip to training max_threshold

# ============================================================
# REDD Dataset Configuration
# ============================================================
REDD:
  metadata:
    name: "REDD"
    description: "Reference Energy Disaggregation Dataset"
    sampling_frequency: "1s"
    num_houses: 6
    location: "USA"

  # Device availability analyzed with scripts/analyze_redd_devices.py
  #
  # Recommended multi-device combinations:
  #   Houses 1,2,3: fridge, microwave, dishwasher (RECOMMENDED)
  #   Houses 1,3:   fridge, microwave, dishwasher, washing_machine
  #   Houses 1,2,3,5: fridge, microwave only
  appliances:
    fridge:
      min_threshold: 40
      max_threshold: 400
      min_on_duration: 6
      min_off_duration: 1
      min_activation_time: 1
      device_type: "cycling_low_power"
      houses: [1, 2, 3, 5, 6]
      activity_rates: {1: 24.78, 2: 46.01, 3: 37.96, 5: 45.81, 6: 50.93}
      redd_name: "fridge"

    microwave:
      min_threshold: 200
      max_threshold: 3000
      min_on_duration: 1
      min_off_duration: 2
      min_activation_time: 1
      device_type: "sparse_high_power"
      houses: [1, 2, 3, 5]
      activity_rates: {1: 1.14, 2: 10.71, 3: 0.74, 5: 7.46}
      redd_name: "microwave"
      loss_override:
        loss_weight_multiplier: 1.6  # Boost MW loss weight (ultra-sparse <1.2% activity)
        w_off_fp: 0.06       # Reduced FP penalty (MW collapsed at 0.12 → too aggressive)
        w_recall: 0.22       # Stronger recall for sparse device recovery
        off_margin: 0.03     # Wider OFF dead zone

    dishwasher:
      min_threshold: 10
      max_threshold: 2500
      min_on_duration: 120
      min_off_duration: 120
      min_activation_time: 10
      device_type: "long_cycle"
      houses: [1, 2, 3, 4]
      activity_rates: {1: 4.11, 2: 1.58, 3: 1.24, 4: 0.54}
      redd_name: "dish washer"

    washing_machine:
      min_threshold: 50
      max_threshold: 6000
      min_on_duration: 60
      min_off_duration: 8
      min_activation_time: 5
      device_type: "sparse_long_cycle"
      houses: [1, 3, 4]
      activity_rates: {1: 1.56, 3: 3.51, 4: 1.45}
      loss_override:
        w_recall: 0.28       # Complex multi-phase cycle needs stronger recall
        w_energy: 0.22       # Better energy tracking for variable power
        alpha_on: 2.8        # Stronger ON detection
        w_on_power: 0.14     # Better ON power accuracy
      redd_name: "washer dryer"

    electric_furnace:
      min_threshold: 80
      max_threshold: 5000
      min_on_duration: 40
      min_off_duration: 20
      min_activation_time: 10
      device_type: "long_cycle"
      houses: [3, 4, 5]
      activity_rates: {3: 2.06, 4: 100.0, 5: 20.47}
      redd_name: "electric furnace"

    electric_heater:
      min_threshold: 80
      max_threshold: 3000
      min_on_duration: 20
      min_off_duration: 8
      min_activation_time: 5
      device_type: "long_cycle"
      houses: [5, 6]
      activity_rates: {5: 12.67, 6: 33.30}
      redd_name: "electric space heater"

    ce_appliance:
      min_threshold: 30
      max_threshold: 1500
      min_on_duration: 1
      min_off_duration: 1
      min_activation_time: 1
      device_type: "cycling_low_power"
      houses: [3, 5, 6]
      activity_rates: {3: 100.0, 5: 7.37, 6: 1.39}
      redd_name: "CE appliance"

    cooker:
      min_threshold: 80
      max_threshold: 5000
      min_on_duration: 5
      min_off_duration: 2
      min_activation_time: 2
      device_type: "sparse_medium_power"
      houses: [2, 4, 6]
      activity_rates: {2: 0.40, 4: 0.25, 6: 0.11}
      redd_name: "electric stove"

  training:
    default_sampling_rate: "1min"
    default_window_size: 128
    overlap: 0.75
    batch_size: 32             # Small dataset: fewer samples per batch for more updates
    epochs: 80                 # V10: More epochs for small dataset with full data
    train_num_crops: 1         # Small dataset: no cropping (preserve all samples)
    learning_rate: 5e-5
    weight_decay: 0.02
    early_stopping_patience: 20
    limit_train_batches: 1.0   # V10: USE ALL DATA
    limit_val_batches: 1.0     # V10: Full validation
    postprocess_use_gate: false   # REDD MW too sparse for gate postprocess (activity <1.2%)
    # Houses 1,2,3 have fridge+microwave+dishwasher with good activity
    default_multi_train: [1, 2]
    default_multi_test: [3]

  # Only override anti-collapse and output_ratio; let HPO handle other loss params
  loss:
    loss_type: "multi_nilm"
    output_ratio: 0.9           # V10: Wider output window

    anti_collapse_weight: 0.2   # V10: Reduced for full-data stability
    state_zero_penalty_weight: 0.0
    state_zero_kernel: 0
    off_high_agg_penalty_weight: 0.0

  postprocess:
    dishwasher:
      threshold: 30
      min_on_steps: 3
    washing_machine:
      threshold: 40
      min_on_steps: 3
    fridge:
      threshold: 20
      min_on_steps: 2
    microwave:
      threshold: 90           # Lowered from 120 (help recover MW from collapse)
      min_on_steps: 1
    cooker:
      threshold: 50
      min_on_steps: 2
    electric_heater:
      threshold: 45
      min_on_steps: 3
    electric_furnace:
      threshold: 50
      min_on_steps: 4

# ============================================================
# REFIT Dataset Configuration
# ============================================================
REFIT:
  metadata:
    name: "REFIT"
    description: "REFIT Smart Home Dataset"
    sampling_frequency: "8s"
    num_houses: 20
    location: "UK"

  appliances:
    # NOTE: REFIT label params use 10s units (1 unit = 10 seconds)
    # because REFIT_DataBuilder resamples to 10s before status computation.
    Dishwasher:
      min_threshold: 50
      max_threshold: 2500
      min_on_duration: 18      # 180s = 3min (in 10s units)
      min_off_duration: 18     # 180s = 3min (in 10s units)
      min_activation_time: 12  # 120s = 2min (in 10s units)
      device_type: "long_cycle"
      houses: [2, 5, 6, 7, 9, 15]
      loss_override:
        w_recall: 0.22       # Reduced from 0.26 (DW was over-predicting: P=0.358, R=0.856)
        w_off_fp: 0.14       # Add FP penalty to curb over-prediction
        off_margin: 0.018    # Wider edge detection for REFIT long wash cycles

    WashingMachine:
      min_threshold: 50
      max_threshold: 2500
      min_on_duration: 18      # 180s = 3min (in 10s units)
      min_off_duration: 2      # 20s (in 10s units; WM has rapid phase transitions)
      min_activation_time: 12  # 120s = 2min (in 10s units)
      device_type: "long_cycle"  # V31: Restored from "cycling". Gradient smoothness loss
      # (Component 8, w_grad) now prevents the all-ON collapse that plagued V17-V30.
      # LONG_CYCLE base: alpha_on=2.5, alpha_off=0.8, w_recall=0.22, recall_coef_base=0.20
      houses: [2, 5, 6, 7, 9, 15]
      # V35c: Match T5 settings (lr=1e-4, wd=0.01, isolation=false, event_bias=0.8).
      # Remove w_recall override — use LONG_CYCLE default (0.22). Keep w_grad for smoothness.
      loss_override:
        w_grad: 0.20         # Keep: gradient smoothness is beneficial

    Kettle:
      min_threshold: 2000
      max_threshold: 3100
      min_on_duration: 1
      min_off_duration: 0
      min_activation_time: 1
      device_type: "sparse_high_power"
      houses: [2, 5, 6, 7, 9, 15]
      loss_override:
        alpha_on: 3.0        # Slightly higher than V8 default (2.8) for REFIT sparse kettle
        w_off_fp: 0.08       # Lower FP penalty than MW - kettle has cleaner ON/OFF edges

    Fridge:
      min_threshold: 50
      max_threshold: 300
      min_on_duration: 6
      min_off_duration: 1
      min_activation_time: 1
      device_type: "cycling_low_power"
      houses: [2, 5, 7, 9, 15]

  training:
    default_sampling_rate: "1min"
    default_window_size: 128
    overlap: 0.5
    batch_size: 128              # V35d: Match T5. batch=2048 causes WM all-ON collapse (confirmed V31-V35c).
    epochs: 50                   # V10: More epochs for full-data training
    learning_rate: 1e-4          # V35b: Match T5.
    weight_decay: 0.01           # V35: Match T5 (100x increase). T5 wd=0.01 prevented WM all-ON collapse; wd=1e-4 always collapses by ep3.
    early_stopping_patience: 12
    limit_train_batches: 1.0     # V10: USE ALL DATA
    limit_val_batches: 1.0       # V10: Full validation
    # Houses [2,5,6,9] train, [7,15] test — good coverage for all 4 devices
    default_multi_train: [2, 5, 6, 9]
    default_multi_test: [7, 15]

  # V33: Re-enable T5-era global penalties in REFIT loss section (this overrides expes.yaml!).
  # V32's expes.yaml changes didn't take effect because this section overrides.
  # Using moderate weights (40-50% of T5) since batch=2048 gives stronger per-step signal.
  loss:
    loss_type: "multi_nilm"
    output_ratio: 0.75             # V35c: Match T5 (was 0.9)
    anti_collapse_weight: 0.5      # V35c: Match T5 (was 0.3)
    state_zero_penalty_weight: 0.05   # V35f: Restore T5 value. multi_nilm override removed, penalties now active.
    state_zero_kernel: 32             # V35f: Restore T5 value (was 0)
    state_zero_ratio: 0.9             # V35f: Restore T5 value
    off_high_agg_penalty_weight: 0.15  # V35f: Restore T5 value (was 0.0)

  postprocess:
    Dishwasher:
      threshold: 50            # Raised from 30 (DW over-predicts, need stricter filter)
      min_on_steps: 4          # Raised from 3 (filter short false-positive bursts)
    WashingMachine:
      threshold: 20
      min_on_steps: 3          # Lowered from 5 (WM has rapid transitions)
    Kettle:
      threshold: 800
      min_on_steps: 2
    Fridge:
      threshold: 18
      min_on_steps: 3
