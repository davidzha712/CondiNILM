# Dataset-specific hyperparameters for NILM training
# This file contains optimized hyperparameters for each dataset

# ============================================================
# UKDALE Dataset Configuration
# ============================================================
UKDALE:
  # Dataset metadata
  metadata:
    name: "UK-DALE"
    description: "UK Domestic Appliance-Level Electricity"
    sampling_frequency: "6s"  # Original sampling rate
    num_houses: 5
    location: "UK"

  # Available appliances with their parameters
  appliances:
    washing_machine:
      min_threshold: 20
      max_threshold: 2500
      min_on_duration: 180
      min_off_duration: 16
      min_activation_time: 12
      device_type: "long_cycle"
      houses: [1, 2, 3, 4, 5]
      # V7.3: REMOVED loss_override - was overriding HPO-optimized params.
      # alpha_off=3.0 (43x HPO's 0.072) caused R=0.234 (77% events missed).
      # HPO-derived params: alpha_off~0.069, lambda_on_recall~5.37 should improve recall.

    dishwasher:
      min_threshold: 10
      max_threshold: 2500
      min_on_duration: 180
      min_off_duration: 180
      min_activation_time: 12
      device_type: "long_cycle"
      houses: [1, 2]
      # V7.3: REMOVED loss_override - let HPO-aligned auto-config take effect.
      # Was overriding alpha_off from 0.069 to 2.8, suppressing recall.

    kettle:
      min_threshold: 2000
      max_threshold: 3100
      min_on_duration: 1
      min_off_duration: 0
      min_activation_time: 1
      device_type: "sparse_high_power"
      houses: [1, 2]
      # V14: REMOVED loss_override - let HPO params control via config_overrides
      # Original HPO Trial #46 achieved F1=0.66 without device-specific overrides

    microwave:
      min_threshold: 200
      max_threshold: 3000
      min_on_duration: 1
      min_off_duration: 3
      min_activation_time: 1
      device_type: "sparse_high_power"
      houses: [1, 2]
      # V14: REMOVED loss_override - let HPO params control via config_overrides

    fridge:
      min_threshold: 50
      max_threshold: 300
      min_on_duration: 6
      min_off_duration: 1
      min_activation_time: 1
      device_type: "cycling_low_power"
      houses: [1, 2, 4]

  # Training configuration
  training:
    default_sampling_rate: "1min"
    default_window_size: 128
    overlap: 0.75
    batch_size: 128
    epochs: 25
    learning_rate: 1e-4
    weight_decay: 0.01
    early_stopping_patience: 5

  # Loss function hyperparameters
  # EXPERIMENT: Restoring original values that achieved F1=0.34
  # Combined with v9 microwave params to prevent collapse
  loss:
    loss_type: "multi_nilm"
    output_ratio: 0.75  # RESTORED from 0.5 - supervise 75% center (was 0.8)
    anti_collapse_weight: 0.5  # INCREASED from 0.15 (original was 0.8, try middle ground)
    state_zero_penalty_weight: 0.05  # INCREASED from 0.01 (original was 0.1)
    state_zero_kernel: 32
    off_high_agg_penalty_weight: 0.15  # INCREASED from 0.05 (original was 0.3)

  # Postprocess configuration per appliance
  postprocess:
    washing_machine:
      threshold: 20       # V7.5j: Lowered from 50 - WM mean_on=539W, 20W is safe
      min_on_steps: 2     # V7.5j: Lowered from 5 - WM rinse/spin phases can be 2-3 steps at 1min
    dishwasher:
      threshold: 20
      min_on_steps: 6
    kettle:
      threshold: 800       # 提高阈值减少假阳性 - kettle功率很高(>2000W)
      min_on_steps: 2
    microwave:
      threshold: 300       # V7.5: Lowered from 500 - soft gate reduces MW preds (~460W), 300W balances P/R
      min_on_steps: 1      # V7.5: Reverted from 2 - real MW events can be single-step at 1-min sampling
    fridge:
      threshold: 18
      min_on_steps: 3

# ============================================================
# REDD Dataset Configuration
# ============================================================
REDD:
  # Dataset metadata
  metadata:
    name: "REDD"
    description: "Reference Energy Disaggregation Dataset"
    sampling_frequency: "1s"  # Original high-frequency, preprocessed to 1s
    num_houses: 6
    location: "USA"

  # Available appliances with their parameters
  # REDD has different appliance names, mapped to standardized names
  # Device availability analyzed with scripts/analyze_redd_devices.py
  #
  # IMPORTANT: When doing multi-device training, only use devices that exist
  # in ALL selected houses with activity > 0.3%
  #
  # Recommended multi-device combinations:
  #   - Houses 1,2,3: fridge, microwave, dishwasher (RECOMMENDED)
  #   - Houses 1,3: fridge, microwave, dishwasher, washing_machine
  #   - Houses 1,2,3,5: fridge, microwave only
  #
  appliances:
    fridge:
      min_threshold: 40
      max_threshold: 400
      min_on_duration: 6
      min_off_duration: 1
      min_activation_time: 1
      device_type: "cycling_low_power"
      houses: [1, 2, 3, 5, 6]  # House 4 has no fridge column
      activity_rates: {1: 24.78, 2: 46.01, 3: 37.96, 5: 45.81, 6: 50.93}
      redd_name: "fridge"

    microwave:
      min_threshold: 200   # Increased from 150 - catches fan/transformer noise at US 120V
      max_threshold: 3000
      min_on_duration: 1
      min_off_duration: 2
      min_activation_time: 1
      device_type: "sparse_high_power"
      houses: [1, 2, 3, 5]  # Houses 4,6 have no microwave column
      activity_rates: {1: 1.14, 2: 10.71, 3: 0.74, 5: 7.46}
      redd_name: "microwave"

    dishwasher:
      min_threshold: 10
      max_threshold: 2500
      min_on_duration: 120
      min_off_duration: 120
      min_activation_time: 10
      device_type: "long_cycle"
      houses: [1, 2, 3, 4]  # Houses 5,6 have 0% activity despite having column
      activity_rates: {1: 4.11, 2: 1.58, 3: 1.24, 4: 0.54}
      redd_name: "dish washer"

    washing_machine:
      min_threshold: 50    # Increased from 15 - catches standby power at US 120V
      max_threshold: 6000
      min_on_duration: 60
      min_off_duration: 8
      min_activation_time: 5
      device_type: "sparse_long_cycle"
      houses: [1, 3, 4]  # Houses 2,5,6 have 0% activity despite having column
      activity_rates: {1: 1.56, 3: 3.51, 4: 1.45}
      redd_name: "washer dryer"

    electric_furnace:
      min_threshold: 80
      max_threshold: 5000
      min_on_duration: 40
      min_off_duration: 20
      min_activation_time: 10
      device_type: "long_cycle"
      houses: [3, 4, 5]  # Houses 1,2,6 have no column
      activity_rates: {3: 2.06, 4: 100.0, 5: 20.47}
      redd_name: "electric furnace"

    electric_heater:
      min_threshold: 80
      max_threshold: 3000
      min_on_duration: 20
      min_off_duration: 8
      min_activation_time: 5
      device_type: "long_cycle"
      houses: [5, 6]  # House 1 has 0.24% (sparse)
      activity_rates: {5: 12.67, 6: 33.30}
      redd_name: "electric space heater"

    ce_appliance:
      min_threshold: 30
      max_threshold: 1500
      min_on_duration: 1
      min_off_duration: 1
      min_activation_time: 1
      device_type: "cycling_low_power"
      houses: [3, 5, 6]
      activity_rates: {3: 100.0, 5: 7.37, 6: 1.39}
      redd_name: "CE appliance"

    cooker:
      min_threshold: 80
      max_threshold: 5000
      min_on_duration: 5
      min_off_duration: 2
      min_activation_time: 2
      device_type: "sparse_medium_power"
      houses: [2, 4, 6]  # All have sparse data (<0.5%)
      activity_rates: {2: 0.40, 4: 0.25, 6: 0.11}
      redd_name: "electric stove"

  # Training configuration (adjusted for REDD characteristics)
  training:
    default_sampling_rate: "1min"
    default_window_size: 128
    overlap: 0.75     # Reverted - 0.875 caused DW collapse and training instability
    batch_size: 64    # Reverted - 32 didn't help with tiny dataset
    epochs: 30  # More epochs due to smaller dataset
    learning_rate: 5e-5  # Lower LR for stability
    weight_decay: 0.02
    early_stopping_patience: 10  # Increased from 7 - need patience for tiny dataset
    limit_train_batches: 1.0  # Use 100% - REDD is small, can't subsample
    limit_val_batches: 1.0    # Use 100% - 0.2 * 1 batch < 1 causes crash

  # Loss function hyperparameters for REDD
  # Only override anti-collapse and output_ratio; let HPO handle other loss params
  # (loss_alpha_on/off, gate params etc. pass through from HPO)
  loss:
    loss_type: "multi_nilm"
    output_ratio: 0.65  # Balanced ratio for both metrics

    # Anti-collapse settings (kept moderate - higher values collapse DW)
    anti_collapse_weight: 0.15
    state_zero_penalty_weight: 0.01
    state_zero_kernel: 12
    off_high_agg_penalty_weight: 0.05

  # Postprocess configuration per appliance
  # NOTE: For sparse devices like microwave, use lower thresholds to catch peaks
  postprocess:
    dishwasher:
      threshold: 30       # Moderate - DW mean_on ~500W, 30W filters low noise
      min_on_steps: 3     # Reduced from 4 - DW events can start/stop within fewer steps
    washing_machine:
      threshold: 40      # Increased from 12 - above standby noise at US 120V
      min_on_steps: 3
    fridge:
      threshold: 20      # Lowered from 25 - US fridge mean_on ~80-150W, 20W is safe
      min_on_steps: 2
    microwave:
      threshold: 120     # Increased from 80 - US MW ~800-1500W, 120W safely above noise
      min_on_steps: 1
    cooker:
      threshold: 50
      min_on_steps: 2
    electric_heater:
      threshold: 45
      min_on_steps: 3
    electric_furnace:
      threshold: 50
      min_on_steps: 4

# ============================================================
# REFIT Dataset Configuration
# ============================================================
REFIT:
  # Dataset metadata
  metadata:
    name: "REFIT"
    description: "REFIT Smart Home Dataset"
    sampling_frequency: "8s"
    num_houses: 20
    location: "UK"

  # Available appliances
  appliances:
    Dishwasher:
      min_threshold: 50    # Increased from 10 - UK DW standby/fan noise 10-40W
      max_threshold: 2500
      min_on_duration: 180
      min_off_duration: 180
      min_activation_time: 12
      device_type: "long_cycle"
      houses: [1, 2, 3, 5, 6, 7, 9, 10, 13, 15, 16, 18, 20]

    WashingMachine:
      min_threshold: 50    # Increased from 20 - UK WM standby 20-50W
      max_threshold: 2500
      min_on_duration: 180
      min_off_duration: 16
      min_activation_time: 12
      device_type: "long_cycle"
      houses: [1, 2, 3, 5, 6, 7, 8, 9, 10, 13, 15, 16, 17, 18, 19]

    Kettle:
      min_threshold: 2000
      max_threshold: 3100
      min_on_duration: 1
      min_off_duration: 0
      min_activation_time: 1
      device_type: "sparse_high_power"
      houses: [2, 3, 4, 5, 6, 7, 9, 12, 13, 15, 19, 20]

    Microwave:
      min_threshold: 200
      max_threshold: 3000
      min_on_duration: 1
      min_off_duration: 3
      min_activation_time: 1
      device_type: "sparse_high_power"
      houses: [2, 3, 4, 6, 8, 9, 10, 12, 13, 15, 17, 18, 19, 20]

    Fridge:
      min_threshold: 50
      max_threshold: 300
      min_on_duration: 6
      min_off_duration: 1
      min_activation_time: 1
      device_type: "cycling_low_power"
      houses: [2, 5, 6, 7, 9, 12, 15, 17, 19, 20]

  # Training configuration
  training:
    default_sampling_rate: "1min"
    default_window_size: 128
    overlap: 0.5
    batch_size: 128
    epochs: 25
    learning_rate: 1e-4
    weight_decay: 0.01
    early_stopping_patience: 5
    limit_train_batches: 0.5  # Use 50% - REFIT has more data than REDD
    limit_val_batches: 1.0    # Use 100% for reliable validation metrics

  # Loss function hyperparameters
  # Only override anti-collapse; let HPO handle output_ratio and other loss params
  loss:
    loss_type: "multi_nilm"
    anti_collapse_weight: 0.5      # Increased from 0.15 - match UKDALE proven value
    state_zero_penalty_weight: 0.05  # Increased from 0.01 - match UKDALE
    state_zero_kernel: 32
    off_high_agg_penalty_weight: 0.15  # Increased from 0.05 - match UKDALE

  # Postprocess configuration
  postprocess:
    Dishwasher:
      threshold: 150      # Increased from 20 - DW mean_on ~500-1000W, 150W filters noise
      min_on_steps: 4     # Reduced from 6 - DW events at 1min sampling can be short
    WashingMachine:
      threshold: 20
      min_on_steps: 5
    Kettle:
      threshold: 800       # Match UKDALE (kettle power >2000W, 800W is safe)
      min_on_steps: 2
    Microwave:
      threshold: 150       # Above noise floor but below real MW events (~700W+)
      min_on_steps: 1      # MW events can be single-step at 1-min sampling
    Fridge:
      threshold: 18
      min_on_steps: 3

# ============================================================
# Common/Shared Configuration
# ============================================================
common:
  # Default device type parameters (optimized for both classification and power regression)
  device_type_params:
    sparse_high_power:
      alpha_on: 6.0  # Weight for ON state loss
      alpha_off: 0.5  # Reduced to avoid over-predicting zeros
      lambda_zero: 0.005  # Very low zero penalty
      lambda_sparse: 0.01
      lambda_off_hard: 0.01
      lambda_on_recall: 2.0  # High recall to catch events
      on_recall_margin: 0.85
      lambda_gate_cls: 0.1
      lambda_energy: 0.3  # Increased for power regression
      off_margin: 0.01

    cycling_low_power:
      alpha_on: 4.0
      alpha_off: 1.5  # Reduced
      lambda_zero: 0.01  # Reduced
      lambda_sparse: 0.005
      lambda_off_hard: 0.05  # Reduced
      lambda_on_recall: 1.5  # Increased
      on_recall_margin: 0.75
      lambda_gate_cls: 0.1
      lambda_energy: 0.4  # Significantly increased for power regression
      off_margin: 0.01

    long_cycle:
      alpha_on: 5.0  # Increased
      alpha_off: 1.0  # Reduced
      lambda_zero: 0.02  # Reduced
      lambda_sparse: 0.01
      lambda_off_hard: 0.03  # Reduced
      lambda_on_recall: 1.5  # Increased
      on_recall_margin: 0.7
      lambda_gate_cls: 0.1
      lambda_energy: 0.35  # Increased for power regression
      off_margin: 0.01

    # For very sparse, long-cycle devices like washing machines in REDD (<5% duty)
    sparse_long_cycle:
      alpha_on: 8.0  # High weight for ON events
      alpha_off: 0.3  # Very low for OFF
      lambda_zero: 0.002  # Very low zero penalty
      lambda_sparse: 0.002
      lambda_off_hard: 0.01
      lambda_on_recall: 3.0  # Very high recall weight
      on_recall_margin: 0.95
      lambda_gate_cls: 0.05
      lambda_energy: 0.2  # Moderate for power regression
      off_margin: 0.005

    sparse_medium_power:
      alpha_on: 4.0
      alpha_off: 0.8
      lambda_zero: 0.1
      lambda_sparse: 0.02
      lambda_off_hard: 0.05
      lambda_on_recall: 0.4
      on_recall_margin: 0.5
      lambda_gate_cls: 0.1
      lambda_energy: 0.08
      off_margin: 0.02

  # Model architecture defaults
  model:
    d_model: 128
    n_encoder_layers: 4
    n_head: 8
    dp_rate: 0.1
    kernel_size: 3
    dilations: [1, 2, 4, 8]
