# Dataset-specific hyperparameters for NILM training.
#
# Loading precedence (later overrides earlier):
#   expes.yaml (base) → models.yaml → datasets.yaml (house splits)
#     → THIS FILE: training/loss/postprocess (OVERRIDES expes.yaml)
#       → HPO override (LAST, filtered for non-UKDALE)
#         → trainer.py _derive_params_from_stats() (OVERRIDES all alphas at runtime)
#
# Each dataset section contains:
#   metadata    - Dataset description and sampling info
#   appliances  - Per-device thresholds, durations, device_type, houses
#   training    - LR, batch size, epochs, overlap, etc.
#   loss        - Loss function params (output_ratio, anti-collapse, etc.)
#   postprocess - Per-device power threshold and min_on_steps for prediction cleanup

# ============================================================
# UKDALE Dataset Configuration
# ============================================================
UKDALE:
  metadata:
    name: "UK-DALE"
    description: "UK Domestic Appliance-Level Electricity"
    sampling_frequency: "6s"
    num_houses: 5
    location: "UK"

  appliances:
    washing_machine:
      min_threshold: 20
      max_threshold: 2500
      min_on_duration: 180
      min_off_duration: 16
      min_activation_time: 12
      device_type: "long_cycle"
      houses: [1, 2, 3, 4, 5]
      loss_override:
        w_recall: 0.28       # Complex multi-phase cycle needs stronger recall
        w_energy: 0.22       # Better energy tracking for variable power
        alpha_on: 2.8        # Stronger ON detection
        w_on_power: 0.14     # Better ON power accuracy

    dishwasher:
      min_threshold: 10
      max_threshold: 2500
      min_on_duration: 180
      min_off_duration: 180
      min_activation_time: 12
      device_type: "long_cycle"
      houses: [1, 2]
      loss_override:
        w_off_fp: 0.14        # Stronger FP penalty (UKDALE DW over-predicts: P=0.39 R=0.97)
        off_margin: 0.02      # Wider OFF dead zone to reduce false positives

    kettle:
      min_threshold: 2000
      max_threshold: 3100
      min_on_duration: 1
      min_off_duration: 0
      min_activation_time: 1
      device_type: "sparse_high_power"
      houses: [1, 2]

    microwave:
      min_threshold: 200
      max_threshold: 3000
      min_on_duration: 1
      min_off_duration: 3
      min_activation_time: 1
      device_type: "sparse_high_power"
      houses: [1, 2]
      loss_override:
        w_off_fp: 0.12       # Extra FP penalty (lower power → more false positives)
        off_margin: 0.03     # Wider OFF dead zone

    fridge:
      min_threshold: 50
      max_threshold: 300
      min_on_duration: 6
      min_off_duration: 1
      min_activation_time: 1
      device_type: "cycling_low_power"
      houses: [1, 2, 4]

  training:
    default_sampling_rate: "1min"
    default_window_size: 128
    overlap: 0.75
    batch_size: 128
    epochs: 25
    learning_rate: 1e-4
    weight_decay: 0.01
    early_stopping_patience: 5
    limit_train_batches: 1.0
    limit_val_batches: 1.0
    # Default multi-device house split (used when datasets.yaml has no entry)
    # Houses 1,2 have all 5 devices with clean data; 3,4,5 have MW quality issues
    default_multi_train: [1]
    default_multi_test: [2]

  loss:
    loss_type: "multi_nilm"
    output_ratio: 0.75
    anti_collapse_weight: 0.5
    state_zero_penalty_weight: 0.05
    state_zero_kernel: 32
    off_high_agg_penalty_weight: 0.15

  postprocess:
    washing_machine:
      threshold: 20
      min_on_steps: 2
    dishwasher:
      threshold: 50            # Raised from 20 (UKDALE DW over-predicts, need stricter filter)
      min_on_steps: 8          # Raised from 6 (filter short false-positive bursts)
    kettle:
      threshold: 800
      min_on_steps: 2
    microwave:
      threshold: 300       # Lowered from 500 - soft gate reduces MW preds (~460W)
      min_on_steps: 1
    fridge:
      threshold: 18
      min_on_steps: 3

# ============================================================
# REDD Dataset Configuration
# ============================================================
REDD:
  metadata:
    name: "REDD"
    description: "Reference Energy Disaggregation Dataset"
    sampling_frequency: "1s"
    num_houses: 6
    location: "USA"

  # Device availability analyzed with scripts/analyze_redd_devices.py
  #
  # Recommended multi-device combinations:
  #   Houses 1,2,3: fridge, microwave, dishwasher (RECOMMENDED)
  #   Houses 1,3:   fridge, microwave, dishwasher, washing_machine
  #   Houses 1,2,3,5: fridge, microwave only
  appliances:
    fridge:
      min_threshold: 40
      max_threshold: 400
      min_on_duration: 6
      min_off_duration: 1
      min_activation_time: 1
      device_type: "cycling_low_power"
      houses: [1, 2, 3, 5, 6]
      activity_rates: {1: 24.78, 2: 46.01, 3: 37.96, 5: 45.81, 6: 50.93}
      redd_name: "fridge"

    microwave:
      min_threshold: 200
      max_threshold: 3000
      min_on_duration: 1
      min_off_duration: 2
      min_activation_time: 1
      device_type: "sparse_high_power"
      houses: [1, 2, 3, 5]
      activity_rates: {1: 1.14, 2: 10.71, 3: 0.74, 5: 7.46}
      redd_name: "microwave"
      loss_override:
        w_off_fp: 0.12       # Extra FP penalty (lower power → more false positives)
        off_margin: 0.03     # Wider OFF dead zone

    dishwasher:
      min_threshold: 10
      max_threshold: 2500
      min_on_duration: 120
      min_off_duration: 120
      min_activation_time: 10
      device_type: "long_cycle"
      houses: [1, 2, 3, 4]
      activity_rates: {1: 4.11, 2: 1.58, 3: 1.24, 4: 0.54}
      redd_name: "dish washer"

    washing_machine:
      min_threshold: 50
      max_threshold: 6000
      min_on_duration: 60
      min_off_duration: 8
      min_activation_time: 5
      device_type: "sparse_long_cycle"
      houses: [1, 3, 4]
      activity_rates: {1: 1.56, 3: 3.51, 4: 1.45}
      loss_override:
        w_recall: 0.28       # Complex multi-phase cycle needs stronger recall
        w_energy: 0.22       # Better energy tracking for variable power
        alpha_on: 2.8        # Stronger ON detection
        w_on_power: 0.14     # Better ON power accuracy
      redd_name: "washer dryer"

    electric_furnace:
      min_threshold: 80
      max_threshold: 5000
      min_on_duration: 40
      min_off_duration: 20
      min_activation_time: 10
      device_type: "long_cycle"
      houses: [3, 4, 5]
      activity_rates: {3: 2.06, 4: 100.0, 5: 20.47}
      redd_name: "electric furnace"

    electric_heater:
      min_threshold: 80
      max_threshold: 3000
      min_on_duration: 20
      min_off_duration: 8
      min_activation_time: 5
      device_type: "long_cycle"
      houses: [5, 6]
      activity_rates: {5: 12.67, 6: 33.30}
      redd_name: "electric space heater"

    ce_appliance:
      min_threshold: 30
      max_threshold: 1500
      min_on_duration: 1
      min_off_duration: 1
      min_activation_time: 1
      device_type: "cycling_low_power"
      houses: [3, 5, 6]
      activity_rates: {3: 100.0, 5: 7.37, 6: 1.39}
      redd_name: "CE appliance"

    cooker:
      min_threshold: 80
      max_threshold: 5000
      min_on_duration: 5
      min_off_duration: 2
      min_activation_time: 2
      device_type: "sparse_medium_power"
      houses: [2, 4, 6]
      activity_rates: {2: 0.40, 4: 0.25, 6: 0.11}
      redd_name: "electric stove"

  training:
    default_sampling_rate: "1min"
    default_window_size: 128
    overlap: 0.75
    batch_size: 32             # Small dataset: fewer samples per batch for more updates
    epochs: 50                 # Small dataset: more epochs to compensate for few batches
    train_num_crops: 1         # Small dataset: no cropping (preserve all samples)
    learning_rate: 5e-5
    weight_decay: 0.02
    early_stopping_patience: 15
    limit_train_batches: 1.0
    limit_val_batches: 1.0
    # Houses 1,2,3 have fridge+microwave+dishwasher with good activity
    default_multi_train: [1, 2]
    default_multi_test: [3]

  # Only override anti-collapse and output_ratio; let HPO handle other loss params
  loss:
    loss_type: "multi_nilm"
    output_ratio: 0.85          # Small dataset: wider output window to capture more signal

    anti_collapse_weight: 0.15
    state_zero_penalty_weight: 0.01
    state_zero_kernel: 12
    off_high_agg_penalty_weight: 0.05

  postprocess:
    dishwasher:
      threshold: 30
      min_on_steps: 3
    washing_machine:
      threshold: 40
      min_on_steps: 3
    fridge:
      threshold: 20
      min_on_steps: 2
    microwave:
      threshold: 120
      min_on_steps: 1
    cooker:
      threshold: 50
      min_on_steps: 2
    electric_heater:
      threshold: 45
      min_on_steps: 3
    electric_furnace:
      threshold: 50
      min_on_steps: 4

# ============================================================
# REFIT Dataset Configuration
# ============================================================
REFIT:
  metadata:
    name: "REFIT"
    description: "REFIT Smart Home Dataset"
    sampling_frequency: "8s"
    num_houses: 20
    location: "UK"

  appliances:
    # NOTE: REFIT label params use 10s units (1 unit = 10 seconds)
    # because REFIT_DataBuilder resamples to 10s before status computation.
    Dishwasher:
      min_threshold: 50
      max_threshold: 2500
      min_on_duration: 18      # 180s = 3min (in 10s units)
      min_off_duration: 18     # 180s = 3min (in 10s units)
      min_activation_time: 12  # 120s = 2min (in 10s units)
      device_type: "long_cycle"
      houses: [2, 5, 6, 7, 9, 15]
      loss_override:
        w_recall: 0.26       # Higher recall for REFIT DW (was under-detecting)
        off_margin: 0.018    # Wider edge detection for REFIT long wash cycles

    WashingMachine:
      min_threshold: 50
      max_threshold: 2500
      min_on_duration: 18      # 180s = 3min (in 10s units)
      min_off_duration: 2      # 20s (in 10s units; WM has rapid phase transitions)
      min_activation_time: 12  # 120s = 2min (in 10s units)
      device_type: "long_cycle"
      houses: [2, 5, 6, 7, 9, 15]
      loss_override:
        w_recall: 0.28       # WM needs stronger recall (complex multi-phase)
        w_energy: 0.22       # Better energy tracking for variable power
        alpha_on: 2.8        # Stronger ON detection
        w_on_power: 0.14     # Better ON power accuracy

    Kettle:
      min_threshold: 2000
      max_threshold: 3100
      min_on_duration: 1
      min_off_duration: 0
      min_activation_time: 1
      device_type: "sparse_high_power"
      houses: [2, 5, 6, 7, 9, 15]
      loss_override:
        alpha_on: 3.0        # Slightly higher than V8 default (2.8) for REFIT sparse kettle
        w_off_fp: 0.08       # Lower FP penalty than MW - kettle has cleaner ON/OFF edges

    Fridge:
      min_threshold: 50
      max_threshold: 300
      min_on_duration: 6
      min_off_duration: 1
      min_activation_time: 1
      device_type: "cycling_low_power"
      houses: [2, 5, 7, 9, 15]

  training:
    default_sampling_rate: "1min"
    default_window_size: 128
    overlap: 0.5
    batch_size: 128
    epochs: 25
    learning_rate: 1e-4
    weight_decay: 0.01
    early_stopping_patience: 5
    limit_train_batches: 1.0
    limit_val_batches: 1.0
    # Houses [2,5,6,9] train, [7,15] test — good coverage for all 4 devices
    default_multi_train: [2, 5, 6, 9]
    default_multi_test: [7, 15]

  # output_ratio=0.75 is CRITICAL for Kettle - HPO's 0.63 causes Kettle collapse
  loss:
    loss_type: "multi_nilm"
    output_ratio: 0.75
    anti_collapse_weight: 0.5
    state_zero_penalty_weight: 0.05
    state_zero_kernel: 32
    off_high_agg_penalty_weight: 0.15

  postprocess:
    Dishwasher:
      threshold: 30            # Lower threshold for REFIT DW (was 150, too strict → low recall)
      min_on_steps: 3
    WashingMachine:
      threshold: 20
      min_on_steps: 3          # Lowered from 5 (WM has rapid transitions)
    Kettle:
      threshold: 800
      min_on_steps: 2
    Fridge:
      threshold: 18
      min_on_steps: 3
